<!DOCTYPE html>
<html lang="en">

<head>

	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="">
	<meta name="author" content="bkupfer">
	<link rel="shortcut icon" href="static/img/favicon.ico" type="image/x-icon">
	<link rel="icon" href="static/img/favicon.ico" type="image/x-icon">

	<title>Crops and Markets</title>

	<!-- Bootstrap Core CSS -->
	<link href="static/css/bootstrap.min.css" rel="stylesheet">

	<!-- Custom CSS -->
	<link href="static/css/simple-sidebar.css" rel="stylesheet">

	<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
	<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
	<!--[if lt IE 9]>
		<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
		<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
	<![endif]-->

	<!-- Google maps -->
	<script src="https://maps.googleapis.com/maps/api/js"></script>

	<script>
	/**  creates the html content for the information window of a marker */
	function createInfoWindowContent(heading, info, whereTo){
		var content = '<div id="content">';
		content += '<div id="siteNotice"></div>';
		content += '<h4 id="firstHeading" class="firstHeading">' + heading + '</h4>';
		for (var i=0; i<info.length; i++)
			content += '<p>' + info[i] + '</p>';
		//content += '<p>'+info+'</p>';
		content += '<a href="' + whereTo + '">';
		content += '<button class="btn btn-default">Ver detalle</button>';
		content += '</a>';
		content += '</div>';
		content += '</div>';

		return content;
	}

	function initialize(){
		// Map
		var mapCanvas = document.getElementById("map-canvas");
		var mapOptions = {
			center: new google.maps.LatLng(-41.092427,-73.1488737),
			zoom: 10,
			mapTypeId: google.maps.MapTypeId.ROADMAP
		}
		var map = new google.maps.Map(mapCanvas, mapOptions);

		// Geocoding and markets
		var geocoder = new google.maps.Geocoder();
		// Use geocodeAddress() method to add markers
		{% for geomarker in geomarkers %}
		geocodeAddress(geocoder, map, "{{ geomarker.address }}", "{{ geomarker.client }}", "{{ geomarker.client.pk }}");
		{% endfor %}

		// Try HTML5 geolocation.
		if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(function(position) {
				var pos = {
					lat: position.coords.latitude,
					lng: position.coords.longitude
				};

				var myCurrentLocationMarker = new google.maps.Marker({
					position: pos,
					map: map, 
					icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png'
				});
				var myCurrentLocationInfoWindow = new google.maps.InfoWindow({
					content: "mi ubicación actual"
				});
				google.maps.event.addListener(myCurrentLocationMarker, 'click', function(){
					myCurrentLocationInfoWindow.open(map, myCurrentLocationMarker);
				}); 

				map.setCenter(pos);
				map.setZoom(12);
			}, function() {
				handleLocationError(true, infoWindow, map.getCenter());
			});
		} 
		else {
			// Browser doesn't support Geolocation
			handleLocationError(false, infoWindow, map.getCenter());
		}
	}

	/** Transforms an address into a google.maps.Marker into the map. 
	  * @ geocoder: google.maps.Geocoder object to be used.
	  * @ map: the map to be used.
	  * @ address: the address to be geocoded.
	  * @ title: title of the marker that will be created in the map.
	  * @ typeOfClient: reduntant definition is redundant. */
	function geocodeAddress(geocoder, map, address, title, idClient){
		geocoder.geocode({'address': address}, function(results, status){
			if (status == google.maps.GeocoderStatus.OK){
				var marker = new google.maps.Marker({
					position: results[0].geometry.location, 
					map: map,
					title: title
				});
				
				// creating information window
				var contentString = createInfoWindowContent(title, [address], 'crop_info?id='+idClient);
				var infoWindow = new google.maps.InfoWindow({
					content: contentString
				});
				google.maps.event.addListener(marker, 'click', function(){
					infoWindow.open(map, marker);
				}); 
			}
			else {
				alert('Geocode was not succesful for the following reason:' + status); 
			}
		});
	}

	function addSampleData(map) {
		// markets
		var marker = new google.maps.Marker({
			position: new google.maps.LatLng(-41.092427,-73.1488737),
			title: 'Campo A'
		});
		var marker2 = new google.maps.Marker({
			position: new google.maps.LatLng(-41.192427,-73.4688737),
			title: 'Campo B'
		});
		marker.setMap(map);
		marker2.setMap(map);

		// content and info windows
		var contentString = createInfoWindowContent('Frutillar',
			['Frutillar es una comuna, ciudad y balneario lacustre ubicada en la zona sur de Chile, en la ribera oeste del lago Llanquihue, en la Región de Los Lagos. Se caracteriza por la belleza de su paisaje, las tradiciones alemanas de sus fundadores y las Semanas Musicales de Frutillar. Es conocida como la "Ciudad de la Música".', 'Attribution: Frutillar, <a href="http://es.wikipedia.org/wiki/Frutillar">http://es.wikipedia.org/wiki/Frutillar</a> (actualizado el Junio 2, 2015).'],
			"crop_info"
		);
		var infowindow = new google.maps.InfoWindow({
			content: contentString
		});

		var contentString2 =
			'<div id="content">'+
				'<div id="siteNotice"></div>'+
				'<h1 id="firstHeading" class="firstHeading">Uluru</h1>'+
				'<div id="bodyContent">'+
					'<p><b>Uluru</b>, also referred to as <b>Ayers Rock</b>, is a large sandstone rock formation in the southern part of the Northern Territory, central Australia. It lies 335&#160;km (208&#160;mi) south west of the nearest large town, Alice Springs; 450&#160;km (280&#160;mi) by road. Kata Tjuta and Uluru are the two major features of the Uluru - Kata Tjuta National Park. Uluru is sacred to the Pitjantjatjara and Yankunytjatjara, the Aboriginal people of the area. It has many springs, waterholes, rock caves and ancient paintings. Uluru is listed as a World Heritage Site.</p>'+
					'<p>Attribution: Uluru, <a href="https://en.wikipedia.org/w/index.php?title=Uluru&oldid=297882194">https://en.wikipedia.org/w/index.php?title=Uluru</a>(last visited June 22, 2009).</p>'+
				'</div>'+
				'<a href="crop_info"><button class="btn btn-default">Más info</button></a>'+
			'</div>';
		var infowindow2 = new google.maps.InfoWindow({
		  content: contentString2
		});

		// action listeners
		google.maps.event.addListener(marker, 'click', function() {
			infowindow.open(map,marker);
		});
		google.maps.event.addListener(marker2, 'click', function() {
			infowindow2.open(map,marker2);
		});
	}

	google.maps.event.addDomListener(window, 'load', initialize);
	</script>

	<style>
	#map-canvas {
		width: 100%;
		height: 700px;
		border-style: solid;
	}
	</style>

</head>

<body>

	<div id="wrapper">

		{% include "sidebar.html" %}

		<div id="page-content-wrapper">
			<div class="container-fluid">
				<div class="row">
					<div class="col-lg-12">
						<h2>Mapa</h2>

						<div class="col-bg-12" id="map-canvas"><!-- map goes here --></div>

						<br>
						<hr><a href="#menu-toggle" class="btn btn-default" id="menu-toggle">Alternar Menu</a>
					</div>
				</div>
			</div>
		</div>

	</div>

	<script src="static/js/jquery.js"></script>
	<script src="static/js/bootstrap.min.js"></script>
	<script src="static/js/menu_toggle.js"></script>
	<script src="static/js/googleanalytics.js"></script>

</body>
</html>