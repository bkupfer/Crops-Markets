<!DOCTYPE html>
<html lang="en">

<head>

	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="crops and markets, and bkupfer's thesis">
	<meta name="keywords" content="semillas sz, crops and markerts, bkupfer">
	<meta name="author" content="bkupfer">
	<link rel="shortcut icon" href="static/img/favicon.ico" type="image/x-icon">
	<link rel="icon" href="static/img/favicon.ico" type="image/x-icon">

	<title>Crops and Markets</title>

	<!-- Bootstrap Core CSS -->
	<link href="static/css/bootstrap.min.css" rel="stylesheet">
	<link href="static/css/simple-sidebar.css" rel="stylesheet">

	<style>
	#map-canvas {
		width: 100%;
		height: 700px;
		border-style: solid;
	}
	</style>

	<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
	<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
	<!--[if lt IE 9]>
		<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
		<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
	<![endif]-->

	<!-- <script src="https://maps.googleapis.com/maps/api/js"></script> -->
	<script src="https://maps.googleapis.com/maps/api/js?sensor=true&v=3"></script>
	<script src="static/js/jquery.js"></script>
	<script async src="static/js/bootstrap.min.js"></script>
	<script async src="static/js/menu_toggle.js"></script>
	<script async src="static/js/googleanalytics.js"></script>

	<script>
	/**  creates the html content for the information window of a marker */
	function createInfoWindowContent(heading, info, whereTo){
		var content = '<div id="content">';
		content += '<div id="siteNotice"></div>';
		content += '<h4 id="firstHeading" class="firstHeading">' + heading + '</h4>';
		for (var i=0; i<info.length; i++)
			content += '<p>' + info[i] + '</p>';
		content += '<a href="' + whereTo + '">';
		content += '<button class="btn btn-default">Ver detalle</button>';
		content += '</a>';
		content += '</div>';
		content += '</div>';

		return content;
	}

	function initialize(){
		// Map
		var mapCanvas = document.getElementById("map-canvas");
		var mapOptions = {
			center: new google.maps.LatLng(-41.092427,-73.1488737),
			zoom: 10,
			mapTypeId: google.maps.MapTypeId.ROADMAP
		}
		var map = new google.maps.Map(mapCanvas, mapOptions);

		// HQ Marker (Semillas-SZ)
		var szMarker = new google.maps.Marker({
			position: new google.maps.LatLng(-41.11949,-73.05709), // semillas-sz coordenates
			map: map, 
			icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
		});
		var szInfoWindow = new google.maps.InfoWindow({
			content: "Semillas SZ"
		});
		google.maps.event.addListener(szMarker, 'click', function(){
			szInfoWindow.open(map, szMarker);
		}); 

		// Geocoding and markets
		var geocoder = new google.maps.Geocoder();
		{% for geomarker in geomarkers %}
			geocodeAddress(geocoder, map, "{{ geomarker.address }}, Region {{ geomarker.region }}, Chile", "{{ geomarker.crop_owner.first }}", "{{ geomarker.crop_owner.first.pk }}",
				{% if geomarker.water and geomarker.soil and geomarker.topography and geomarker.temperatures %}
					true
				{% else %}
					false
				{% endif %});
		{% endfor %}

		// Try HTML5 geolocation.
		if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(function(position) {
				var pos = {
					lat: position.coords.latitude,
					lng: position.coords.longitude
				};

				var myCurrentLocationMarker = new google.maps.Marker({
					position: pos,
					map: map, 
					icon: 'http://maps.google.com/mapfiles/ms/icons/purple-dot.png'
				});
				var myCurrentLocationInfoWindow = new google.maps.InfoWindow({
					content: "mi ubicación actual"
				});
				google.maps.event.addListener(myCurrentLocationMarker, 'click', function(){
					myCurrentLocationInfoWindow.open(map, myCurrentLocationMarker);
				}); 

				map.setCenter(pos);
				map.setZoom(12);
			}, function() {
				handleLocationError(true, infoWindow, map.getCenter());
			});
		} 
		else {
			// Browser doesn't support Geolocation
			handleLocationError(false, infoWindow, map.getCenter());
		}
	}

	/** Transforms an address into a google.maps.Marker into the map. 
	  * @ geocoder: google.maps.Geocoder object to be used.
	  * @ map: the map to be used.
	  * @ address: the address to be geocoded.
	  * @ title: title of the marker that will be created in the map.
	  * @ typeOfClient: reduntant definition is redundant. */
	function geocodeAddress(geocoder, map, address, title, idCrop, req_ok){
		geocoder.geocode({'address': address}, function(results, status){
			if (status == google.maps.GeocoderStatus.OK){
				var marker = new google.maps.Marker({
					position: results[0].geometry.location, 
					map: map,
					title: title
				});
				(req_ok) ? marker.setIcon('http://maps.google.com/mapfiles/ms/icons/green-dot.png') : marker.setIcon('http://maps.google.com/mapfiles/ms/icons/red-dot.png');

				// creating information window
				var contentString = createInfoWindowContent(title, [address], 'crop_info?id='+idCrop);
				var infoWindow = new google.maps.InfoWindow({
					content: contentString
				});
				google.maps.event.addListener(marker, 'click', function(){
					infoWindow.open(map, marker);
				}); 
			}
			else {
				alert('Geocode was not succesful for the following reason:' + status); 
			}
		});
	}

	google.maps.event.addDomListener(window, 'load', initialize);
	</script>
</head>

<body>

	<div id="wrapper">

		{% include "sidebar.html" %}

		<div id="page-content-wrapper">
			<div class="container-fluid">
				<div class="row">
					<div class="col-lg-12">
						<h2>Mapa</h2>

						<div class="col-bg-12" id="map-canvas"><!-- map goes here --></div>
						<div class="col-sm-12">
							<p class="text-right small">Los marcadores de color <label style="color:green">verde</label> y <label style="color:red">rojo</label> representan los predios que <label style="color:green">cumplen</label> y <label style="color:red">no cumplen</label> los requisitos mínimos respectivamente. <br>
							El marcador <label style="color: purple">púrpura</label> representa su <label style="color: purple">posición actual</label>, y el marcador <label style="color: blue">azul</label> la posición de <label style="color: blue">Semillas SZ</label>.</p>
						</div>
						<br>
						<hr><a href="#menu-toggle" class="btn btn-default" id="menu-toggle">Alternar Menu</a>
					</div>
				</div>
			</div>
		</div>

	</div>

</body>
</html>